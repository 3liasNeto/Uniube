# ==================================================================================== #
# VARI√ÅVEIS
# ==================================================================================== #

# Configura√ß√µes do banco de dados
DB_USER ?= postgres
DB_PASSWORD ?= Alves@180204
DB_HOST ?= localhost
DB_PORT ?= 5432
DB_NAME ?= quizgame
DB_SSLMODE ?= disable

# String de conex√£o
DATABASE_URL = postgres://$(DB_USER):$(DB_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=$(DB_SSLMODE)

# Diret√≥rios
MIGRATIONS_DIR = db/migrations
SCHEMAS_DIR = db/schemas

# ==================================================================================== #
# DESENVOLVIMENTO
# ==================================================================================== #

.PHONY: help
help: ## Mostra esta mensagem de ajuda
	@echo 'Usage:'
	@sed -n 's/^##//p' ${MAKEFILE_LIST} | column -t -s ':' | sed -e 's/^/ /'

.PHONY: run
run: ## Roda a aplica√ß√£o
	go run main.go

.PHONY: build
build: ## Compila a aplica√ß√£o
	go build -o bin/app main.go

# ==================================================================================== #
# BANCO DE DADOS - MIGRATIONS
# ==================================================================================== #

.PHONY: migrate-create
migrate-create: ## Cria uma nova migration (use name=nome_da_migration)
	@if [ -z "$(name)" ]; then \
		echo "‚ùå Erro: forne√ßa um nome para a migration usando name=nome_da_migration"; \
		exit 1; \
	fi
	migrate create -ext sql -dir $(MIGRATIONS_DIR) -seq $(name)
	@echo "‚úÖ Migration criada em $(MIGRATIONS_DIR)"

.PHONY: migrate-up
migrate-up: ## Executa todas as migrations pendentes
	@echo "üöÄ Executando migrations..."
	migrate -path $(MIGRATIONS_DIR) -database "$(DATABASE_URL)" -verbose up
	@echo "‚úÖ Migrations executadas com sucesso!"

.PHONY: migrate-down
migrate-down: ## Reverte a √∫ltima migration
	@echo "‚è™ Revertendo √∫ltima migration..."
	migrate -path $(MIGRATIONS_DIR) -database "$(DATABASE_URL)" -verbose down 1
	@echo "‚úÖ Migration revertida!"

.PHONY: migrate-down-all
migrate-down-all: ## Reverte todas as migrations
	@echo "‚ö†Ô∏è  ATEN√á√ÉO: Isso ir√° reverter TODAS as migrations!"
	@read -p "Tem certeza? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		migrate -path $(MIGRATIONS_DIR) -database "$(DATABASE_URL)" -verbose down -all; \
		echo "‚úÖ Todas as migrations foram revertidas!"; \
	else \
		echo "‚ùå Opera√ß√£o cancelada."; \
	fi

.PHONY: migrate-force
migrate-force: ## For√ßa uma vers√£o espec√≠fica (use version=N)
	@if [ -z "$(version)" ]; then \
		echo "‚ùå Erro: forne√ßa uma vers√£o usando version=N"; \
		exit 1; \
	fi
	migrate -path $(MIGRATIONS_DIR) -database "$(DATABASE_URL)" force $(version)
	@echo "‚úÖ Vers√£o for√ßada para $(version)"

.PHONY: migrate-version
migrate-version: ## Mostra a vers√£o atual da migration
	@migrate -path $(MIGRATIONS_DIR) -database "$(DATABASE_URL)" version

.PHONY: migrate-status
migrate-status: ## Mostra o status das migrations
	@echo "üìä Status das migrations:"
	@migrate -path $(MIGRATIONS_DIR) -database "$(DATABASE_URL)" version || echo "Nenhuma migration aplicada"

# ==================================================================================== #
# SQLC
# ==================================================================================== #

.PHONY: sqlc-generate
sqlc-generate: ## Gera c√≥digo Go a partir das queries SQL
	@echo "üîß Gerando c√≥digo SQLC..."
	sqlc generate
	@echo "‚úÖ C√≥digo SQLC gerado com sucesso!"

.PHONY: sqlc-compile
sqlc-compile: ## Verifica se as queries SQL s√£o v√°lidas
	@echo "üîç Validando queries SQL..."
	sqlc compile
	@echo "‚úÖ Queries SQL v√°lidas!"

.PHONY: sqlc-vet
sqlc-vet: ## Executa an√°lise est√°tica nas queries
	@echo "üîç Analisando queries..."
	sqlc vet
	@echo "‚úÖ An√°lise conclu√≠da!"

# ==================================================================================== #
# BANCO DE DADOS - OPERA√á√ïES
# ==================================================================================== #

.PHONY: db-create
db-create: ## Cria o banco de dados
	@echo "üóÑÔ∏è  Criando banco de dados $(DB_NAME)..."
	psql -h $(DB_HOST) -p $(DB_PORT) -U $(DB_USER) -c "CREATE DATABASE $(DB_NAME);" || echo "‚ö†Ô∏è  Banco j√° existe"
	@echo "‚úÖ Banco de dados criado!"

.PHONY: db-drop
db-drop: ## Remove o banco de dados
	@echo "‚ö†Ô∏è  ATEN√á√ÉO: Isso ir√° DELETAR o banco $(DB_NAME)!"
	@read -p "Tem certeza? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		psql -h $(DB_HOST) -p $(DB_PORT) -U $(DB_USER) -c "DROP DATABASE IF EXISTS $(DB_NAME);"; \
		echo "‚úÖ Banco de dados removido!"; \
	else \
		echo "‚ùå Opera√ß√£o cancelada."; \
	fi

.PHONY: db-reset
db-reset: db-drop db-create migrate-up ## Remove, recria e executa as migrations
	@echo "‚úÖ Banco de dados resetado com sucesso!"

.PHONY: db-seed
db-seed: ## Popula o banco com dados de teste
	@echo "üå± Populando banco de dados..."
	@go run db/seeds/seed.go
	@echo "‚úÖ Dados de seed inseridos!"

# ==================================================================================== #
# DOCKER
# ==================================================================================== #

.PHONY: docker-up
docker-up: ## Sobe os containers do Docker
	docker-compose up -d
	@echo "‚úÖ Containers iniciados!"

.PHONY: docker-down
docker-down: ## Para os containers do Docker
	docker-compose down
	@echo "‚úÖ Containers parados!"

.PHONY: docker-logs
docker-logs: ## Mostra os logs dos containers
	docker-compose logs -f

# ==================================================================================== #
# TESTES
# ==================================================================================== #

.PHONY: test
test: ## Executa todos os testes
	go test -v ./...

.PHONY: test-coverage
test-coverage: ## Executa testes com cobertura
	go test -v -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out

# ==================================================================================== #
# LIMPEZA
# ==================================================================================== #

.PHONY: clean
clean: ## Remove arquivos tempor√°rios e bin√°rios
	rm -rf bin/
	rm -f coverage.out
	@echo "‚úÖ Limpeza conclu√≠da!"

# ==================================================================================== #
# WORKFLOW COMPLETO
# ==================================================================================== #

.PHONY: setup
setup: db-create migrate-up sqlc-generate ## Setup inicial do projeto
	@echo "‚úÖ Projeto configurado com sucesso!"

.PHONY: dev
dev: sqlc-generate run ## Gera c√≥digo e roda a aplica√ß√£o

.PHONY: fresh
fresh: db-reset sqlc-generate ## Reseta o banco e regenera o c√≥digo
	@echo "‚úÖ Ambiente atualizado!"